# Project Board Automation - Auto-move issues through Kanban columns
name: Project Board Automation

on:
  issues:
    types: [opened, closed, reopened, assigned, unassigned]
  pull_request:
    types: [opened, closed, review_requested, ready_for_review]

permissions:
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  # Add new issues to project board
  add-to-project:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    
    steps:
      - name: Add issue to project
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/users/MCKRUZ/projects/1
          github-token: ${{ secrets.PROJECT_TOKEN }}

  # Auto-link PRs to issues based on branch name
  link-pr-to-issue:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    
    steps:
      - name: Extract issue number from branch
        id: extract
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          # Match patterns like: feature/issue-42, fix/issue-123, issue-5
          if [[ $BRANCH =~ issue-([0-9]+) ]]; then
            echo "issue_number=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "Found issue number: ${BASH_REMATCH[1]}"
          else
            echo "No issue number found in branch: $BRANCH"
            echo "issue_number=" >> $GITHUB_OUTPUT
          fi
      
      - name: Link PR to issue
        if: steps.extract.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.extract.outputs.issue_number }};
            const prNumber = context.payload.pull_request.number;
            const prBody = context.payload.pull_request.body || '';
            
            // Check if PR body already references the issue
            if (prBody.includes(`#${issueNumber}`) || prBody.includes(`closes #${issueNumber}`)) {
              console.log('PR already references issue');
              return;
            }
            
            // Update PR body to link to issue
            const newBody = `Closes #${issueNumber}\n\n${prBody}`;
            
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              body: newBody,
            });
            
            console.log(`Linked PR #${prNumber} to issue #${issueNumber}`);

  # Label PRs based on files changed
  label-pr:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Label PR based on files
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  # Add "in-progress" label when issue is assigned
  mark-in-progress:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'assigned'
    
    steps:
      - name: Add in-progress label
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: ['in-progress']
            });

  # Remove "in-progress" when unassigned
  mark-not-in-progress:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'unassigned'
    
    steps:
      - name: Remove in-progress label
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                name: 'in-progress'
              });
            } catch (e) {
              console.log('Label not present, skipping removal');
            }
